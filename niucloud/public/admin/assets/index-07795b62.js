import{a2 as T,d as ae,r as m,s as se,a0 as K,h as n,I as q,w as l,y as L,c,e,a as t,t as o,u as r,N as a,F as R,G as A,B as F,z as M,af as ne,ag as J,a8 as oe,an as ue,ao as ce,a1 as ie,ap as re,aq as de,aa as pe,$ as xe,i as S,a3 as Z,ar as ke,E as ye,p as be,g as we}from"./index-30b146d4.js";/* empty css                   */import{T as _e,_ as fe}from"./vue-web-terminal-551cb123.js";/* empty css                *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                   */import{_ as ve}from"./_plugin-vue_export-helper-c27b6911.js";function Ce(g=""){return T.get(g?`upgrade/${g}`:"upgrade")}function Be(){return T.get("upgrade/task")}function Te(g=""){return T.post(g?`upgrade/${g}`:"upgrade")}function Ee(){return T.post("upgrade/execute",{},{timeout:0})}function $e(g=""){return T.get(g?`upgrade/check/${g}`:"upgrade/check")}function Ie(){return T.post("upgrade/clear")}function Ue(){return T.post("niucloud/build",{},{timeout:0})}function Se(){return T.get("niucloud/build")}function Ve(){return T.get("niucloud/build/log")}function Fe(){return T.post("niucloud/build/clear")}function Le(){return T.get("niucloud/build/check")}const Me={class:"h-[60vh]"},Ne={key:0,class:"h-[60vh] flex flex-col"},Re={key:0,class:"bg-[#fff] my-3"},De={class:"pt-[20px] pl-[20px]"},He={class:"px-[20px] pt-[10px] text-[14px] el-table"},je={key:0},qe={key:1},Ae={key:0},Pe={key:1},ze={class:"h-[60vh]"},Ge={class:"h-[60vh] flex flex-col"},Ke={class:"flex-1 h-0"},Je=ae({__name:"index",emits:["complete"],setup(g,{expose:O,emit:ee}){const i=m(!1),d=m(null),p=m("build"),h=m(null),w=m(!1),x=m(null);let C=[];(()=>{Se().then(({data:_})=>{_&&(d.value=_,i.value||W())}).catch()})();const $=()=>{Ve().then(_=>{if(!_.data){i.value&&C.length&&(p.value="complete",x.value.execute("clear")),I&&I.close(),d.value=null;return}const f=_.data.data??[];let v="";f[0]&&f[0].length&&i.value&&(C.length==0&&(x.value.execute("clear"),x.value.execute("开始编译")),f[0].forEach(k=>{C.includes(k.action)||(x.value.pushMessage({content:`正在执行：${k.action}`}),C.push(k.action),k.code==0&&(v=k.msg,x.value.pushMessage({content:k.msg,class:"error"})))})),!v&&setTimeout(()=>{$()},2e3)}).catch()};let I=null;const W=()=>{I=ne.success({title:a("warning"),dangerouslyUseHTMLString:!0,message:J("div",{},[a("cloudbuild.executingTips"),J("span",{class:"text-primary cursor-pointer",onClick:V},[a("cloudbuild.clickView")])]),duration:0,showClose:!1})},V=()=>{i.value=!0,p.value="build",$()},X=async()=>{if(i.value=!0,w.value=!0,p.value="build",d.value){w.value=!1,$();return}Le().then(async({data:_})=>{_.is_pass?Ue().then(({data:f})=>{w.value=!1,d.value=f,$()}).catch(()=>{i.value=!1}):(w.value=!1,h.value=_)}).catch(()=>{i.value=!1})};let D=null;const P=new _e,Y=(_,f,v,k,j)=>{if(f=="开始编译"){v(P);const s=H(["/","——","\\","|"]);D=setInterval(()=>{P.flush("> "+s.next().value)},150)}},H=_=>{var f=0;return{next(){return f+1==_.length&&(f=0),{value:_[f++]}}}},z=_=>{p.value=="cloudbuild"&&d.value?oe.confirm(a("cloudbuild.showDialogCloseTips"),a("warning"),{confirmButtonText:a("confirm"),cancelButtonText:a("cancel"),type:"warning"}).then(()=>{_()}).catch(()=>{}):_()};return se(()=>i.value,()=>{i.value||(p.value="build",C=[],D&&clearInterval(D),Fe())}),O({open:X,cloudBuildTask:d}),(_,f)=>{const v=ue,k=ce,j=K("Select"),s=ie,u=K("CloseBold"),E=re,U=de,N=pe,y=xe;return n(),q(N,{modelValue:i.value,"onUpdate:modelValue":f[0]||(f[0]=B=>i.value=B),title:r(a)("cloudbuild.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":z},{default:l(()=>[L((n(),c("div",Me,[h.value&&!d.value?(n(),c("div",Ne,[e(E,null,{default:l(()=>[h.value.dir?(n(),c("div",Re,[t("p",De,o(r(a)("cloudbuild.dirPermission")),1),t("div",He,[e(k,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(r(a)("cloudbuild.path")),1)]),_:1}),e(v,{span:6},{default:l(()=>[t("span",null,o(r(a)("cloudbuild.demand")),1)]),_:1}),e(v,{span:6},{default:l(()=>[t("span",null,o(r(a)("status")),1)]),_:1})]),_:1}),(n(!0),c(R,null,A(h.value.dir.is_readable,B=>(n(),q(k,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(B.dir),1)]),_:2},1024),e(v,{span:6},{default:l(()=>[t("span",null,o(r(a)("cloudbuild.readable")),1)]),_:1}),e(v,{span:6},{default:l(()=>[B.status?(n(),c("span",je,[e(s,{color:"green"},{default:l(()=>[e(j)]),_:1})])):(n(),c("span",qe,[e(s,{color:"red"},{default:l(()=>[e(u)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(n(!0),c(R,null,A(h.value.dir.is_write,B=>(n(),q(k,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(B.dir),1)]),_:2},1024),e(v,{span:6},{default:l(()=>[t("span",null,o(r(a)("cloudbuild.write")),1)]),_:1}),e(v,{span:6},{default:l(()=>[B.status?(n(),c("span",Ae,[e(s,{color:"green"},{default:l(()=>[e(j)]),_:1})])):(n(),c("span",Pe,[e(s,{color:"red"},{default:l(()=>[e(u)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):F("",!0)]),_:1})])):F("",!0),L(t("div",ze,[e(r(fe),{ref_key:"terminalRef",ref:x,context:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:Y},null,512)],512),[[M,d.value]])])),[[M,p.value=="build"],[y,w.value]]),L(t("div",null,[t("div",Ge,[t("div",Ke,[e(U,{icon:"success",title:r(a)("cloudbuild.cloudbuildSuccess")},null,8,["title"])])])],512),[[M,p.value=="complete"]])]),_:1},8,["modelValue","title"])}}});const Oe=ve(Je,[["__scopeId","data-v-5a176c78"]]),Qe=g=>(be("data-v-50e0c682"),g=g(),we(),g),We={key:0,class:"h-[60vh] flex flex-col"},Xe={class:"text-lg"},Ye={class:"font-bold"},Ze={class:"font-bold"},el={key:0,class:"mt-[10px]"},ll=Qe(()=>t("a",{class:"text-primary",href:"https://www.niucloud.com",target:"_blank"},"niucloud-admin官网",-1)),tl={class:"font-bold text-lg"},al={class:"mt-[5px]"},sl=["innerHTML"],nl={class:"flex justify-end"},ol={key:0,class:"h-[60vh] flex flex-col"},ul={key:0,class:"bg-[#fff] my-3"},cl={class:"pt-[20px] pl-[20px]"},il={class:"px-[20px] pt-[10px] text-[14px] el-table"},rl={key:0},dl={key:1},pl={key:0},_l={key:1},fl={class:"h-[60vh]"},vl={class:"h-[60vh] flex flex-col"},gl={class:"flex-1 h-0"},hl={class:"flex justify-end"},ml=ae({__name:"index",emits:["complete"],setup(g,{expose:O,emit:ee}){const i=m(!1),d=m(null),p=m(null),h=m("content"),w=m(null),x=m(!1),C=m(null),Q=m(null);let $=[];const I=()=>{Be().then(({data:s})=>{if(s){if(!i.value){X();return}if(p.value||(C.value.execute("clear"),C.value.execute("开始升级")),s.log.forEach(u=>{$.includes(u)||(C.value.pushMessage({content:`正在执行：${u}`}),$.push(u))}),s.error){p.value=s,Z({message:"升级失败",type:"error"}),C.value.pushMessage({content:s.error,class:"error"});return}if(s.step=="upgradeComplete"){h.value="complete",V&&V.close(),ee("complete");return}p.value=s,W()}}).catch()};I();const W=()=>{Ee().then(()=>{I()}).catch()};let V=null;const X=()=>{V=ne.success({title:a("warning"),dangerouslyUseHTMLString:!0,message:J("div",{},[a("upgrade.upgradingTips"),J("span",{class:"text-primary cursor-pointer",onClick:D},[a("upgrade.clickView")])]),duration:0,showClose:!1})},D=()=>{i.value=!0,h.value="upgrade",I(),V&&V.close()},P=async()=>{var u,E;if(x.value)return;x.value=!0;const s=((u=d.value)==null?void 0:u.app.app_key)!="niucloud-admin"?(E=d.value)==null?void 0:E.app.app_key:"";await $e(s).then(async({data:U})=>{U.is_pass?await Te(s).then(()=>{I()}).catch(()=>{x.value=!1}):w.value=U}).catch(),x.value&&(h.value="upgrade")},Y=(s="")=>{if(p.value){Z({message:"已有正在执行中的升级任务",type:"error"}),i.value=!0;return}Ce(s).then(({data:u})=>{if(d.value=u,!u.version_list.length){Z({message:"已经是最新版本了",type:"error"});return}i.value=!0}).catch()};let H=null;const z=new _e,_=(s,u,E,U,N)=>{if(u=="开始升级"){E(z);const y=f(["/","——","\\","|"]);H=setInterval(()=>{z.flush("> "+y.next().value)},150)}},f=s=>{var u=0;return{next(){return u+1==s.length&&(u=0),{value:s[u++]}}}},v=s=>{h.value=="upgrade"&&p.value&&!p.value.error?oe.confirm(a("upgrade.showDialogCloseTips"),a("warning"),{confirmButtonText:a("confirm"),cancelButtonText:a("cancel"),type:"warning"}).then(()=>{s()}).catch(()=>{}):s()};se(()=>i.value,()=>{i.value||k()});const k=()=>{h.value="content",x.value=!1,p.value=null,$=[],H&&clearInterval(H),Ie().then(()=>{}).catch()},j=()=>{var s;i.value=!1,(s=Q.value)==null||s.open()};return O({open:Y}),(s,u)=>{const E=ke,U=re,N=ye,y=ue,B=ce,le=K("Select"),G=ie,te=K("CloseBold"),ge=de,he=pe;return n(),c(R,null,[e(he,{modelValue:i.value,"onUpdate:modelValue":u[1]||(u[1]=b=>i.value=b),title:r(a)("upgrade.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":v},{default:l(()=>[L(t("div",null,[d.value?(n(),c("div",We,[t("div",Xe,[S(" 本次升级将从"),t("span",Ye,o(d.value.version),1),S("升级到"),t("span",Ze,o(d.value.upgrade_version),1),S("版本 ")]),d.value.upgrade_version!=d.value.last_version?(n(),c("div",el,[e(E,{type:"info","show-icon":""},{title:l(()=>[S(" 当前最新版本为"+o(d.value.last_version)+"，您的服务已于"+o(d.value.expire_time)+"到期。如需升级到最新版可在",1),ll,S("购买相关服务后再进行升级 ")]),_:1})])):F("",!0),e(U,{class:"flex-1 h-0 mt-[20px]"},{default:l(()=>[(n(!0),c(R,null,A(d.value.version_list,(b,me)=>(n(),c("div",{class:"mt-[20px]",key:me},[t("div",tl,o(b.version_no),1),t("div",al,o(b.release_time),1),b.upgrade_log?(n(),c("div",{key:0,class:"mt-[10px] p-[10px] rounded bg-[#f4f4f5] whitespace-pre",innerHTML:b.upgrade_log},null,8,sl)):F("",!0)]))),128))]),_:1})])):F("",!0),t("div",nl,[e(N,{type:"primary",onClick:P,loading:x.value},{default:l(()=>[S(o(r(a)("upgrade.upgradeButton")),1)]),_:1},8,["loading"])])],512),[[M,h.value=="content"]]),L(t("div",null,[w.value&&!p.value?(n(),c("div",ol,[e(U,null,{default:l(()=>[w.value.dir?(n(),c("div",ul,[t("p",cl,o(r(a)("upgrade.dirPermission")),1),t("div",il,[e(B,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(y,{span:12},{default:l(()=>[t("span",null,o(r(a)("upgrade.path")),1)]),_:1}),e(y,{span:6},{default:l(()=>[t("span",null,o(r(a)("upgrade.demand")),1)]),_:1}),e(y,{span:6},{default:l(()=>[t("span",null,o(r(a)("status")),1)]),_:1})]),_:1}),(n(!0),c(R,null,A(w.value.dir.is_readable,b=>(n(),q(B,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(y,{span:12},{default:l(()=>[t("span",null,o(b.dir),1)]),_:2},1024),e(y,{span:6},{default:l(()=>[t("span",null,o(r(a)("upgrade.readable")),1)]),_:1}),e(y,{span:6},{default:l(()=>[b.status?(n(),c("span",rl,[e(G,{color:"green"},{default:l(()=>[e(le)]),_:1})])):(n(),c("span",dl,[e(G,{color:"red"},{default:l(()=>[e(te)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(n(!0),c(R,null,A(w.value.dir.is_write,b=>(n(),q(B,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(y,{span:12},{default:l(()=>[t("span",null,o(b.dir),1)]),_:2},1024),e(y,{span:6},{default:l(()=>[t("span",null,o(r(a)("upgrade.write")),1)]),_:1}),e(y,{span:6},{default:l(()=>[b.status?(n(),c("span",pl,[e(G,{color:"green"},{default:l(()=>[e(le)]),_:1})])):(n(),c("span",_l,[e(G,{color:"red"},{default:l(()=>[e(te)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):F("",!0)]),_:1})])):F("",!0),L(t("div",fl,[e(r(fe),{ref_key:"terminalRef",ref:C,context:p.value?p.value.upgrade.app_key:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:_},null,8,["context"])],512),[[M,p.value]])],512),[[M,h.value=="upgrade"]]),L(t("div",null,[t("div",vl,[t("div",gl,[e(ge,{icon:"success",title:r(a)("upgrade.upgradeSuccess")},null,8,["title"]),e(E,{title:r(a)("upgrade.upgradeCompleteTips"),type:"error",closable:!1},null,8,["title"])]),t("div",hl,[e(N,{type:"default",onClick:u[0]||(u[0]=b=>i.value=!1)},{default:l(()=>[S(o(r(a)("upgrade.localBuild")),1)]),_:1}),e(N,{type:"primary",onClick:j},{default:l(()=>[S(o(r(a)("upgrade.cloudBuild")),1)]),_:1})])])],512),[[M,h.value=="complete"]])]),_:1},8,["modelValue","title"]),e(Oe,{ref_key:"cloudBuildRef",ref:Q},null,512)],64)}}});const Il=ve(ml,[["__scopeId","data-v-50e0c682"]]);export{Oe as C,Il as U};
